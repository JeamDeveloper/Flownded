<!DOCTYPE html>
<html>
<head>
    <title>Detecci√≥n de Key de Autotune</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14"></script>
    <script src="https://cdn.jsdelivr.net/npm/tonal@5"></script>
</head>
<body>
    <form id="upload-form">
        <input type="file" id="music-file" accept=".mp3,.wav">
    </form>
    <div id="progress">Cargando archivo...</div>
    <div id="result" style="display: none;"></div>

    <script>
        async function processFile(file) {
            const reader = new FileReader();

            reader.onload = async function(event) {
                const arrayBuffer = event.target.result;
                const audioBuffer = await Tone.context.decodeAudioData(arrayBuffer);
                detectKeyUsingTonal(audioBuffer);
            };

            reader.readAsArrayBuffer(file);
        }

        function detectKeyUsingTonal(audioBuffer) {
            const audioData = [];
            for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                audioData.push(audioBuffer.getChannelData(channel));
            }

            const key = tonal.key.getKey(audioData, audioBuffer.sampleRate);
            const keyName = tonal.Note.pc(key.tonic) + (key.mode === 'minor' ? 'm' : '');

            const progressDiv = document.getElementById('progress');
            const resultDiv = document.getElementById('result');

            progressDiv.style.display = 'none';
            resultDiv.style.display = 'block';
            resultDiv.innerText = `La Key detectada es: ${keyName}`;
        }

        const fileInput = document.getElementById('music-file');
        fileInput.addEventListener('change', function(event) {
            const selectedFile = event.target.files[0];
            if (selectedFile) {
                const progressDiv = document.getElementById('progress');
                const progressText = document.createElement('span');
                progressDiv.innerHTML = 'Procesando...';
                progressDiv.appendChild(progressText);

                const reader = new FileReader();
                reader.onload = async function(event) {
                    const arrayBuffer = event.target.result;
                    const audioBuffer = await Tone.context.decodeAudioData(arrayBuffer);

                    let processedFrames = 0;
                    const totalFrames = audioBuffer.length;
                    const batchSize = 1024;

                    const processBatch = async () => {
                        const remainingFrames = totalFrames - processedFrames;
                        const framesToProcess = Math.min(batchSize, remainingFrames);

                        const audioData = [];
                        for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                            audioData.push(audioBuffer.getChannelData(channel).subarray(processedFrames, processedFrames + framesToProcess));
                        }

                        processedFrames += framesToProcess;

                        const progressPercentage = Math.floor((processedFrames / totalFrames) * 100);
                        progressText.innerText = `Procesando... ${progressPercentage}%`;

                        if (processedFrames < totalFrames) {
                            await processBatch();
                        } else {
                            progressDiv.style.display = 'none';
                            detectKeyUsingTonal(audioBuffer);
                        }
                    };

                    processBatch();
                };

                reader.readAsArrayBuffer(selectedFile);
            }
        });
    </script>
</body>
</html>
