<!DOCTYPE html>
<html>
<head>
    <title>Reproductor de video con ExoPlayer</title>
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f5f5f5;
        }

        #playerContainer {
            width: 640px;
            height: 360px;
        }

        .input-field {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .input-field input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .input-field button {
            flex-shrink: 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/exoplayer-hls.js@1.18.6/dist/hls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exoplayer-core@1.18.6/dist/exoplayer-core.js"></script>
    <script>
        async function reproducirEnlace() {
            var enlaceCifrado = document.getElementById('enlaceCifrado').value;
            var claveCifrado = localStorage.getItem('claveCifrado');

            if (enlaceCifrado && claveCifrado) {
                var claveBuffer = await window.crypto.subtle.importKey(
                    'raw',
                    new TextEncoder().encode(claveCifrado),
                    { name: 'AES-CBC' },
                    false,
                    ['decrypt']
                );

                var iv = new Uint8Array(16); // Vector de inicializaciÃ³n (IV) para el modo CBC
                var enlaceCifradoBuffer = new Uint8Array(atob(enlaceCifrado).split('').map(char => char.charCodeAt(0)));

                var enlaceOriginalBuffer = await window.crypto.subtle.decrypt(
                    {
                        name: 'AES-CBC',
                        iv: iv
                    },
                    claveBuffer,
                    enlaceCifradoBuffer
                );

                var enlaceOriginal = new TextDecoder().decode(enlaceOriginalBuffer);

                if (enlaceOriginal) {
                    var playerContainer = document.getElementById('playerContainer');
                    var player = new window.ExoPlayer.Player(playerContainer);

                    player.configure({
                        sources: [{
                            src: enlaceOriginal,
                            type: 'application/x-mpegURL'
                        }],
                        autoplay: true,
                        aspectRatio: '16:9',
                        hls: {
                            enableWorker: true,
                            enableSoftwareAES: true
                        }
                    });

                    player.play();
                }
            }
        }
    </script>
</head>
<body>
    <div class="input-field">
        <input type="text" id="enlaceCifrado" placeholder="Enlace cifrado" />
        <button onclick="reproducirEnlace()">Reproducir</button>
    </div>
    <div id="playerContainer"></div>
</body>
</html>
